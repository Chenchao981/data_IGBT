# DC数据清洗项目 - 任务规划

## 项目概述

将ASEData/DC目录下的所有xlsx测试数据文件清洗整理成统一格式的DC数据文件。

## 目标

- 输入：`.\ASEData\DC\` 目录下所有xlsx文件（FT测试数据）
- 输出：`DC_[时间戳].xlsx` 文件，包含19个测试参数的标准格式数据

## 项目结构

```
data_IGBT/
├── ASEData/DC/                # 源数据目录
├── output/                    # 输出目录
├── dc_processing/             # DC处理专用文件夹
│   ├── dc_cleaner.py         # 主程序文件
│   ├── todo_DC.md            # 本文档
│   ├── dc_core_logic.md      # 核心代码说明文档
│   └── dc_cleaner.log        # 运行日志
├── sample/                    # 示例数据目录
└── requirements.txt          # 依赖包列表
```

## 数据分析

### 源数据格式特点（图1格式）

- 复杂的FT测试数据表格，包含状态信息、颜色编码
- 多行表头结构：
  - 第1行：Item Status, Color, Test等基础信息
  - 第2行：测试项目名称（CONT右边的所有参数，SAME参数要去除）
  - 第3-6行：测试限制条件、偏置条件等
  - 第7行：单位行（通过检测"unit"字段确认，参数与单位交叉处为该参数单位）
  - 第8-9行：统计信息（Min, Max, Range, Average）
  - "Test No."行的下一行：实际测试数据开始

### 目标数据格式（图2格式）

动态列数标准输出格式：

1. NUM - 连续编号
2. lot_ID - 从文件名直接获取（完整文件名去掉.xlsx扩展名）
3. 其余列 - 根据源文件第2行CONT右边的所有参数动态确定
   - 重复参数用数字区分（如VTH1, VTH2, VTH3）
   - **SAME参数跳过不统计**
   - 列名格式：参数名(单位)，单位从第7行获取

**示例输出格式**（基于当前文件结构）：

- VTH1(V), VTH2(V), BVDSS1(V), BVDSS2(V), IDSS40(nA), IGSS25(nA), ISGS25(nA)
- IGSS20(nA), ISGS20(nA), LRDON10(mR), LRDON4.5(mR), HVFSD+(V), IDSS35(nA)
- IGSS10(nA), ISGS10(nA), VTH3(V), ABSDEL1, ABSDEL2

## 核心模块设计

### 1. 文件扫描模块 (scan_dc_files)

- **功能**：扫描DC目录下所有xlsx文件
- **输入**：目录路径
- **输出**：文件路径列表
- **状态**：⏳ 待开发

### 2. 数据定位与提取模块 (extract_dc_data)

- **功能**：从单个xlsx文件中提取DC测试数据
- **输入**：单个xlsx文件路径
- **输出**：DataFrame包含动态数量的测试参数和文件名
- **关键逻辑**：
  - 定位第2行，找到CONT右边的所有参数，跳过SAME参数
  - 定位第7行，通过检测"unit"字段确认单位行
  - 参数与单位交叉处获取该参数的单位
  - 重复参数用数字区分（VTH1, VTH2, VTH3等）
  - 定位"Test No."行，下一行开始提取测试数据
- **状态**：⏳ 待开发

### 3. 批次信息提取模块 (extract_batch_info)

- **功能**：从文件名中提取批次信息
- **输入**：文件路径
- **输出**：批次字符串（使用正则表达式提取FA4Z-2484模式）
- **提取规则**：使用正则表达式`[A-Z0-9]{4}-[0-9]{4}`提取，如匹配失败则回退到完整文件名
- **状态**：✅ 已完成

### 4. 数据汇总模块 (merge_all_dc_data)

- **功能**：合并所有文件的DC数据
- **输入**：多个DataFrame
- **输出**：统一的DataFrame
- **状态**：⏳ 待开发

### 5. 数据清洗模块 (clean_and_format_dc)

- **功能**：DC数据清洗和格式化
- **输入**：原始合并数据
- **输出**：清洗后的标准格式数据
- **清洗规则**：
  - 过滤非数值测试数据
  - 生成连续NUM编号
  - 标准化批次格式
  - 保持数值精度
- **状态**：⏳ 待开发

### 6. 输出模块 (save_dc_result)

- **功能**：保存最终DC结果
- **输入**：清洗后的数据
- **输出**：DC_[时间戳].xlsx文件
- **状态**：⏳ 待开发

## 任务安排

### Phase 1: 基础框架搭建

- [x] 创建dc_cleaner.py主程序文件
- [x] 设置依赖环境（复用现有requirements.txt）
- [x] 创建DC数据定位逻辑文档
- [x] 实现文件扫描功能

### Phase 2: 数据结构分析

- [x] 详细分析DC源数据文件结构
- [x] 动态解析第2行CONT右边的所有参数（跳过SAME）
- [x] 通过第7行"unit"字段定位参数单位
- [x] 确定"Test No."行下一行为数据起始的定位方法
- [x] 实现重复参数的数字编号逻辑（VTH1, VTH2, VTH3）

### Phase 3: 核心数据提取

- [x] 实现单文件DC数据提取逻辑
- [x] 测试"Test No."行定位功能
- [x] 测试动态参数列数据提取（跳过SAME列）
- [x] 实现批次信息提取功能（正则表达式提取FA4Z-2484模式）
- [x] 实现参数-单位匹配逻辑
- [x] 处理异常情况（文件格式不符等）

### Phase 4: 数据处理与合并

- [x] 实现数据汇总功能
- [x] 实现连续编号NUM生成
- [x] 实现DC数据清洗功能
- [x] 测试数据完整性和精度

### Phase 5: 输出与优化

- [x] 实现输出功能
- [x] 添加时间戳生成
- [x] 性能优化
- [x] 错误处理完善

### Phase 6: 测试与文档

- [x] 全流程测试
- [x] 边界情况测试
- [x] 用户使用说明
- [x] 代码注释完善

## 技术要求

- **语言**：Python 3.x
- **主要依赖**：pandas, openpyxl
- **GUI框架**：如需要界面，使用PyQt5
- **开发环境**：Windows 11
- **代码复用**：参考DVDS和RG处理逻辑，适配DC数据特点

## 开发进度

### 2025-06-18

- [x] **lot_ID提取逻辑重构**
  - [x] 将批次信息提取从完整文件名改为正则表达式提取
  - [x] 实现正则表达式`[A-Z0-9]{4}-[0-9]{4}`匹配FA4Z-2484模式
  - [x] 添加匹配失败时回退到完整文件名的容错机制
  - [x] 测试验证提取逻辑正确性
  - [x] 生成新的DC数据文件，lot_ID正确显示为"FA4Z-2484"

### 2025-01-20

- [x] 项目需求分析完成
- [x] 创建todo_DC.md文档
- [x] 创建dc_processing专用目录
- [x] Phase 1基础框架搭建完成
  - [x] 创建dc_cleaner.py主程序文件（含完整框架）
  - [x] 实现文件扫描功能（成功扫描到2个DC文件）
  - [x] 设置日志系统
- [x] Phase 2-6全部开发完成！
  - [x] 数据结构分析完成，创建dc_core_logic.md文档
  - [x] 实现动态参数提取（18个参数，跳过SAME列）
  - [x] 实现重复参数编号（VTH1, VTH2, VTH3等）
  - [x] 实现完整数据提取和清洗流程
  - [x] 成功处理2个文件，输出12557行数据
  - [x] 输出格式：NUM | lot_ID | 18个测试参数列

## 特殊注意事项

1. **动态参数解析**：第2行CONT右边的所有参数都要统计，SAME参数要跳过
2. **单位定位**：第7行通过"unit"字段确认，参数与单位交叉处获取单位信息
3. **重复参数处理**：重复参数用数字区分（VTH1, VTH2, VTH3）
4. **批次信息**：使用正则表达式`[A-Z0-9]{4}-[0-9]{4}`从文件名中提取（如FA4Z-2484）
5. **数据定位**："Test No."行的下一行直接就是测试数据开始
6. **数据精度**：保持原始数据的数值精度，特别是小数位数
7. **列名格式**：输出格式为"参数名(单位)"

## 与DVDS/RG项目的区别

1. **参数数量**：DC有动态数量参数（预计10+个），远超DVDS的1个和RG的1个
2. **参数定位**：需要动态解析第2行CONT右边的所有参数
3. **SAME列处理**：需要跳过SAME列，这是DC特有的
4. **单位获取**：需要从第7行"unit"字段处获取单位
5. **重复参数**：需要对重复参数进行数字编号
6. **批次处理**：直接使用完整文件名，不需要正则匹配
7. **文件前缀**：输出文件前缀为"DC_"

## 测试用例

- 测试单个DC文件处理
- 测试批量DC文件处理
- 测试19个参数提取准确性
- 测试批次信息提取正确性
- 测试空文件夹情况
- 测试文件格式异常情况
- 测试数据精度保持
- 测试跨文件NUM连续性

## 预期输出示例

```
NUM | lot_ID    | VTH1(V) | VTH2(V) | BVDSS1(V) | BVDSS2(V) | IDSS40(nA) | ...
1   | FA4Z-2484 | 1.7877  | 1.8955  | 45.8984   | 45.9663   | 133.5314   | ...
2   | FA4Z-2484 | 1.8155  | 1.9233  | 45.5797   | 45.6543   | 142.4493   | ...
3   | FA4Z-2484 | 1.8498  | 1.9576  | 45.5254   | 45.5729   | 148.485    | ...
```

## 核心算法逻辑

### 参数提取算法

1. 读取第2行，找到"CONT"列位置
2. 从CONT右边开始遍历所有列，跳过值为"SAME"的列
3. 对重复参数名进行计数，添加数字后缀（VTH1, VTH2, VTH3）
4. 读取第7行"unit"字段，获取每个参数对应的单位
5. 生成最终列名格式：参数名(单位)

### 数据提取算法

1. 定位"Test No."行
2. 从下一行开始提取测试数据
3. 按照参数列位置提取对应数值
4. 批次信息使用正则表达式`[A-Z0-9]{4}-[0-9]{4}`从文件名提取（如FA4Z-2484）
