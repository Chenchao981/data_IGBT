# RG数据清洗项目 - 任务规划

## 项目概述

将ASEData/RG目录下的所有xlsx测试数据文件清洗整理成统一格式的RG数据文件。

## 目标

- 输入：`.\ASEData\RG\` 目录下所有xlsx文件
- 输出：`RG_[时间戳].xlsx` 文件，包含三列：NUM, lot_ID, RG(R)

## 项目结构

```
data_IGBT/
├── ASEData/RG/                    # 源数据目录
├── output/                        # 输出目录
├── rg_processing/                 # RG处理专用目录
│   ├── rg_cleaner.py             # RG处理主程序文件
│   ├── todo_RG.md                # 本文档
│   ├── rg_data_location_logic.md # RG数据定位逻辑详细规划
│   └── rg_cleaner.log            # RG运行日志
├── dvds_processing/               # DVDS处理目录
├── sample/                        # 示例数据目录
└── requirements.txt              # 依赖包列表
```

## 数据分析

### 源数据格式特点

- 复杂的FT测试数据表格
- 包含测试状态、颜色编码、多个测试项目
- RG数据位于特定列（推测为第K列或类似位置）
- 数据从第20行左右开始（需要定位"Test No."行）

### 目标数据格式

- NUM：连续编号（跨文件连续）
- lot_ID：从文件名中提取
- RG(R)：从源数据中提取的RG阻值

## 核心模块设计

### 1. 文件扫描模块 (scan_rg_files)

- **功能**：扫描RG目录下所有xlsx文件
- **输入**：目录路径
- **输出**：文件路径列表
- **状态**：⏳ 待开发

### 2. 数据定位与提取模块 (extract_rg_data)

- **功能**：从单个xlsx文件中提取RG数据
- **输入**：单个xlsx文件路径
- **输出**：DataFrame包含RG数值和文件名
- **关键逻辑**：
  - 定位"Test No."行作为数据起始标识
  - 定位RG列（可能在K列或通过列标题搜索"RG"）
  - 从数据行开始提取RG数值
- **状态**：⏳ 待开发

### 3. lot_ID提取模块 (extract_lot_id)

- **功能**：从文件名中提取lot_ID
- **输入**：文件路径
- **输出**：lot_ID字符串
- **提取规则**：从文件名中识别批次号（如FA4Z-2482）
- **状态**：⏳ 待开发

### 4. 数据汇总模块 (merge_all_rg_data)

- **功能**：合并所有文件的RG数据
- **输入**：多个DataFrame
- **输出**：统一的DataFrame
- **状态**：⏳ 待开发

### 5. 数据清洗模块 (clean_and_format_rg)

- **功能**：RG数据清洗和格式化
- **输入**：原始合并数据
- **输出**：清洗后的标准格式数据
- **清洗规则**：
  - 过滤非数值RG数据
  - 生成连续NUM编号
  - 标准化lot_ID格式
- **状态**：⏳ 待开发

### 6. 输出模块 (save_rg_result)

- **功能**：保存最终RG结果
- **输入**：清洗后的数据
- **输出**：RG_[时间戳].xlsx文件
- **状态**：⏳ 待开发

## 任务安排

### Phase 1: 基础框架搭建

- [x] 创建rg_cleaner.py主程序文件
- [x] 设置依赖环境（复用DVDS项目的requirements.txt）
- [x] 创建RG数据定位逻辑规划文档
- [x] 实现文件扫描功能

### Phase 2: 数据结构分析

- [x] 详细分析RG源数据文件结构
- [x] 确定RG数据列的准确位置（第2行动态寻找）
- [x] 确定数据起始行的定位方法（Test No.行+1）
- [x] 分析lot_ID提取规则（直接使用文件名）

### Phase 3: 核心数据提取

- [x] 实现单文件RG数据提取逻辑
- [x] 测试"Test No."行定位
- [x] 测试RG列数据提取
- [x] 实现lot_ID提取功能
- [x] 处理异常情况（文件格式不符等）

### Phase 4: 数据处理与合并

- [x] 实现数据汇总功能
- [x] 实现连续编号NUM生成
- [x] 实现RG数据清洗功能
- [x] 测试数据完整性

### Phase 5: 输出与优化

- [x] 实现输出功能
- [x] 添加时间戳生成
- [x] 性能优化
- [x] 错误处理完善

### Phase 6: 测试与文档

- [x] 全流程测试
- [x] 边界情况测试
- [x] 用户使用说明
- [x] 代码注释完善

## 技术要求

- **语言**：Python 3.x
- **主要依赖**：pandas, openpyxl
- **GUI框架**：如需要界面，使用PyQt5
- **开发环境**：Windows 11
- **代码复用**：参考DVDS处理逻辑，适配RG数据特点

## 开发进度

### 2025-01-03

- [x] 项目需求分析完成
- [x] 创建todo_RG.md文档
- [x] 创建rg_processing专用目录
- [x] 创建RG数据定位逻辑规划文档
- [x] Phase 1-6全部开发完成
- [x] 成功运行并生成RG数据文件

### 项目完成状态

**✅ 项目已完成并验证成功！**

- **处理文件**: 2个RG源文件
- **输出数据**: 12,567条RG数据
- **输出文件**: `RG_20250618_104910.xlsx`
- **数据质量**: RG值范围4.78-5.63Ω，平均5.24Ω
- **格式标准**: NUM, lot_ID, RG(R)三列格式

## 特殊注意事项

1. **数据定位差异**：RG数据的列位置可能与DVDS不同，需要动态搜索
2. **lot_ID提取**：RG文件名格式与DVDS可能不同，需要适配提取规则
3. **数据格式**：RG阻值单位确认（从图片看是R，即欧姆）
4. **文件数量**：当前RG目录只有2个文件，但要考虑扩展性
5. **数据连续性**：NUM编号要跨文件保持连续

## 与DVDS项目的区别

1. **数据类型**：DVDS是电压值(mV)，RG是阻值(R)
2. **列位置**：RG数据列位置需要重新定位
3. **文件命名**：输出文件前缀为"RG_"而非"DVDS_"
4. **lot_ID规则**：可能需要不同的文件名解析规则

## 测试用例

- 测试单个RG文件处理
- 测试批量RG文件处理
- 测试空文件夹情况
- 测试文件格式异常情况
- 测试RG数据列定位准确性
- 测试lot_ID提取正确性

## 预期输出示例

```
NUM | lot_ID                                                                      | RG(R)
1   | ST1_NCEAP40PT15D(M)-2B00_1-0_FA4Z-2482_NCT5452009_P_001_20250102152204    | 5.387
2   | ST1_NCEAP40PT15D(M)-2B00_1-0_FA4Z-2482_NCT5452009_P_001_20250102152204    | 5.407
3   | ST1_NCEAP40PT15D(M)-2B00_1-0_FA4Z-2482_NCT5452009_P_001_20250102152204    | 5.39
...
```
